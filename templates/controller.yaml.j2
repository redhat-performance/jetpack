heat_template_version: ocata

description: >
  Software Config to drive os-net-config to configure multiple interfaces
  for the controller role.

parameters:
  ControlPlaneIp:
    default: ''
    description: IP address/subnet on the ctlplane network
    type: string
  ExternalIpSubnet:
    default: ''
    description: IP address/subnet on the external network
    type: string
  InternalApiIpSubnet:
    default: ''
    description: IP address/subnet on the internal API network
    type: string
  StorageIpSubnet:
    default: ''
    description: IP address/subnet on the storage network
    type: string
  StorageMgmtIpSubnet:
    default: ''
    description: IP address/subnet on the storage mgmt network
    type: string
  TenantIpSubnet:
    default: ''
    description: IP address/subnet on the tenant network
    type: string
  ManagementIpSubnet: # Only populated when including environments/network-management.yaml
    default: ''
    description: IP address/subnet on the management network
    type: string
  ExternalNetworkVlanID:
    default: 10
    description: Vlan ID for the external network traffic.
    type: number
  InternalApiNetworkVlanID:
    default: 20
    description: Vlan ID for the internal_api network traffic.
    type: number
  StorageNetworkVlanID:
    default: 30
    description: Vlan ID for the storage network traffic.
    type: number
  StorageMgmtNetworkVlanID:
    default: 40
    description: Vlan ID for the storage mgmt network traffic.
    type: number
  TenantNetworkVlanID:
    default: 50
    description: Vlan ID for the tenant network traffic.
    type: number
  ExternalInterfaceDefaultRoute:
    default: '10.0.0.1'
    description: default route for the external network
    type: string
  ControlPlaneSubnetCidr: # Override this via parameter_defaults
    default: '24'
    description: The subnet CIDR of the control plane network.
    type: string
  ControlPlaneDefaultRoute: # Override this via parameter_defaults
    description: The subnet CIDR of the control plane network.
    type: string
  DnsServers: # Override this via parameter_defaults
    default: []
    description: A list of DNS servers (2 max for some implementations) that will be added to resolv.conf.
    type: json
  EC2MetadataIp: # Override this via parameter_defaults
    description: The IP address of the EC2 metadata server.
    type: string
{%raw%}{% if install.version|openstack_release >= 15 %}{%endraw%}

  ControlPlaneStaticRoutes:
    default: []
    description: >
      Routes for the ctlplane network traffic.
      JSON route e.g. [{'destination':'10.0.0.0/16', 'nexthop':'10.0.0.1'}]
      Unless the default is changed, the parameter is automatically resolved
      from the subnet host_routes attribute.
    type: json
  ControlPlaneMtu:
    default: 1500
    description: The maximum transmission unit (MTU) size(in bytes) that is
      guaranteed to pass through the data path of the segments in the network.
      (The parameter is automatically resolved from the ctlplane network's mtu attribute.)
    type: number
  StorageMtu:
    default: 1500
    description: The maximum transmission unit (MTU) size(in bytes) that is
      guaranteed to pass through the data path of the segments in the
      Storage network.
    type: number
  StorageMgmtMtu:
    default: 1500
    description: The maximum transmission unit (MTU) size(in bytes) that is
      guaranteed to pass through the data path of the segments in the
      StorageMgmt network.
    type: number
  InternalApiMtu:
    default: 1500
    description: The maximum transmission unit (MTU) size(in bytes) that is
      guaranteed to pass through the data path of the segments in the
      InternalApi network.
    type: number
  TenantMtu:
    default: 1500
    description: The maximum transmission unit (MTU) size(in bytes) that is
      guaranteed to pass through the data path of the segments in the
      Tenant network.
    type: number
  ExternalMtu:
    default: 1500
    description: The maximum transmission unit (MTU) size(in bytes) that is
      guaranteed to pass through the data path of the segments in the
      External network.
    type: number
  ManagementMtu:
    default: 1500
    description: The maximum transmission unit (MTU) size(in bytes) that is
      guaranteed to pass through the data path of the segments in the
      Management network.
    type: number
{%raw%}{% endif %}{%endraw%}

{%raw%}{% if install.version|openstack_release >= 14 %}{%endraw%}

  StorageInterfaceRoutes:
    default: []
    description: >
      Routes for the storage network traffic.
      JSON route e.g. [{'destination':'10.0.0.0/16', 'nexthop':'10.0.0.1'}]
      Unless the default is changed, the parameter is automatically resolved
      from the subnet host_routes attribute.
    type: json
  StorageMgmtInterfaceRoutes:
    default: []
    description: >
      Routes for the storage_mgmt network traffic.
      JSON route e.g. [{'destination':'10.0.0.0/16', 'nexthop':'10.0.0.1'}]
      Unless the default is changed, the parameter is automatically resolved
      from the subnet host_routes attribute.
    type: json
  InternalApiInterfaceRoutes:
    default: []
    description: >
      Routes for the internal_api network traffic.
      JSON route e.g. [{'destination':'10.0.0.0/16', 'nexthop':'10.0.0.1'}]
      Unless the default is changed, the parameter is automatically resolved
      from the subnet host_routes attribute.
    type: json
  TenantInterfaceRoutes:
    default: []
    description: >
      Routes for the tenant network traffic.
      JSON route e.g. [{'destination':'10.0.0.0/16', 'nexthop':'10.0.0.1'}]
      Unless the default is changed, the parameter is automatically resolved
      from the subnet host_routes attribute.
    type: json
  ExternalInterfaceRoutes:
    default: []
    description: >
      Routes for the external network traffic.
      JSON route e.g. [{'destination':'10.0.0.0/16', 'nexthop':'10.0.0.1'}]
      Unless the default is changed, the parameter is automatically resolved
      from the subnet host_routes attribute.
    type: json
  ManagementInterfaceRoutes:
    default: []
    description: >
      Routes for the management network traffic.
      JSON route e.g. [{'destination':'10.0.0.0/16', 'nexthop':'10.0.0.1'}]
      Unless the default is changed, the parameter is automatically resolved
      from the subnet host_routes attribute.
    type: json
{%raw%}{% endif %}{%endraw%}


resources:
  OsNetConfigImpl:
    type: OS::Heat::SoftwareConfig
    properties:
      group: script
      config:
        list_join:
        - ''
        - - |
            #!/bin/bash
            function network_config_hook {
              function get_python() {
                command -v python3 || command -v python2 || command -v python || exit 1
              }
            $(get_python) -c "
            import json
            import yaml


            with open('/etc/os-net-config/mapping.yaml') as yaml_file:
              mapping = yaml.load(yaml_file)

            net_config = {'network_config': [] }
            with open('/etc/os-net-config/config.json') as json_file:
              data = json.load(json_file)
            for config in data['network_config']:
              interface = {}
              if config['type'] == 'ovs_bridge':
                for member in config['members']:
                  if member['type'] == 'interface':
                    interface = member
                    break
              elif config['type'] == 'interface':
                interface = config
              if not interface:
                continue
              nic_mapping = interface.get('nic_mapping')
              for k,v in nic_mapping.items():
                if (('interface_mapping' in mapping) and (nic_mapping[k] in mapping['interface_mapping'])):
                  nic_mapping[v] = mapping['interface_mapping'][nic_mapping[k]]
              if nic_mapping[v] == nic_mapping[k]:
                interface.pop('nic_mapping')  
              net_config['network_config'].append(config)

            with open('/etc/os-net-config/config.json', 'w') as outfile:
              json.dump(net_config, outfile)
            "
            }

          -
            str_replace:
              template:
                  get_file: {%raw%}{{ install.heat.templates.basedir }}{%endraw%}/network/scripts/run-os-net-config.sh
              params:
                   $network_config:
                       network_config:
                        -
                          type: ovs_bridge
                          name: br-ex
                          use_dhcp: false
{% if external_interface == ctlplane_interface %}
                          addresses:
                            -
                              ip_netmask:
                                list_join:
                                  - '/'
                                  - - get_param: ControlPlaneIp
                                    - get_param: ControlPlaneSubnetCidr
                          routes:
                            -
                              ip_netmask: 169.254.169.254/32
                              next_hop:
                                  get_param: EC2MetadataIp
{% endif %}
                          members:
                            -
                              type: interface
                              name: {{ external_interface }}
                              nic_mapping:
                                {{ external_interface }}: {{ external_interface }}
                            -
                              type: vlan
                              vlan_id:
                                  get_param: ExternalNetworkVlanID
                              addresses:
                              -
                                ip_netmask:
                                    get_param: ExternalIpSubnet
{% if external_interface != ctlplane_interface %}
                        -
                          type: ovs_bridge
                          name: br-ctlplane
                          use_dhcp: false
                          members:
                            -
                              type: interface
                              name: {{ ctlplane_interface }}
                              nic_mapping:
                                {{ ctlplane_interface }}: {{ ctlplane_interface }}
                          addresses:
                            -
                              ip_netmask:
                                list_join:
                                  - '/'
                                  - - get_param: ControlPlaneIp
                                    - get_param: ControlPlaneSubnetCidr
                          routes:
                            -
                              ip_netmask: 169.254.169.254/32
                              next_hop:
                                  get_param: EC2MetadataIp
{% endif %}
{% if ifaces|length > 1 %}
                        -
                          type: ovs_bridge
                          name: br-isolated
                          use_dhcp: false
                          members:
                            -
                              type: interface
                              name: {{ isolated_interface }}
                              nic_mapping:
                                {{ isolated_interface }}: {{ isolated_interface }}
{% endif %}
                            -
                              type: vlan
                              vlan_id:
                                  get_param: InternalApiNetworkVlanID
                              addresses:
                              -
                                ip_netmask:
                                    get_param: InternalApiIpSubnet
                            -
                              type: vlan
                              vlan_id:
                                  get_param: StorageNetworkVlanID
                              addresses:
                              -
                                ip_netmask:
                                    get_param: StorageIpSubnet
                            -
                              type: vlan
                              vlan_id:
                                  get_param: StorageMgmtNetworkVlanID
                              addresses:
                              -
                                ip_netmask:
                                    get_param: StorageMgmtIpSubnet
{% if ifaces|length > 2 %}
                        -
                          type: ovs_bridge
                          name: br-tenant
                          use_dhcp: false
                          members:
                            -
                              type: interface
                              name: {{ tenant_interface }}
                              nic_mapping:
                                {{ tenant_interface }}: {{ tenant_interface }}
{% endif %}
                            -
                              type: vlan
                              vlan_id:
                                  get_param: TenantNetworkVlanID
                              addresses:
                              -
                                ip_netmask:
                                    get_param: TenantIpSubnet

outputs:
  OS::stack_id:
    description: The OsNetConfigImpl resource.
    value:
        get_resource: OsNetConfigImpl
